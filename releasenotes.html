<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EPICS Base: EPICS 7.0 Release Notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EPICS Base
   &#160;<span id="projectnumber">7.0.4.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">EPICS 7.0 Release Notes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>These release notes describe changes that have been made since the previous release of this series of EPICS Base. <b>Note that changes which were merged up from commits to new releases in an older Base series are not described at the top of this file but have entries that appear lower down, under the series to which they were originally committed.</b> Thus it is important to read more than just the first section to understand everything that has changed in each release.</p>
<p>The PVA submodules each have their own individual sets of release notes which should also be read to understand what has changed since earlier releases.</p>
<p><b>This version of EPICS has not been released yet.</b></p>
<h2>Changes made on the 7.0 branch since 7.0.4.1</h2>
<h2>EPICS Release 7.0.4.1</h2>
<h3>ARM Architecture Changes</h3>
<p>Build configuration files for a new cross-build architecture <code>linux-aarch64</code> have been added, and the targets <code>linux-arm_el</code> and <code>linux-arm_eb</code> removed. The 64-bit ARM architecture target doesn't have build files for self-hosting yet but they should be relatively easy to add, contributions welcome!</p>
<h3>Bug fixes</h3>
<p>The following bugs/issues have fixes included in this release:</p>
<ul>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1884339">lp: 1884339</a>, Inaccessible CA servers on Windows</li>
<li><a href="https://github.com/epics-base/epics-base/issues/83">github: 83</a> osdTimeGetCurrent doesn't work for subprocess on macOS</li>
<li>Recent Cygwin build problem with a missing <code>TCP_NODELAY</code> declaration.</li>
</ul>
<h3>Perl CA Bindings under Conda</h3>
<p>Builds of the Perl CA bindings weren't working properly when the Perl installation was from Conda. This release also fixed the capr.pl script to handle the INT64 data types, and to be able to properly handle missing fields, as happens if the IOC is running an older EPICS version for example.</p>
<h3>epicsMessageQueue implementation on RTEMS</h3>
<p>The implementation of the <code>epicsMessageQueue</code> used on RTEMS has switched from the native RTEMS-specific one to the EPICS generic version, avoiding a bug in the RTEMS Kernel message queue code.</p>
<h3>Record Name Validation</h3>
<p>Historically, there have been very few restrictions on which characters may be present in record and alias names. Base 3.14.12.3 added a warning for names containing space, single or double quote, period/dot, or dollar sign.</p>
<div class="fragment"><div class="line">Bad character &#39; &#39; in record name &quot;bad practice&quot;</div></div><!-- fragment --><p>7.0.4.1 Turns this warning into an error, and adds a new warning if a record name begins with a minus, plus, left square bracket, or left curly bracket.</p>
<h2>EPICS Release 7.0.4</h2>
<h3>Bug fixes</h3>
<p>The following launchpad bugs have fixes included in this release:</p>
<ul>
<li><a href="https://bugs.launchpad.net/bugs/1812084">lp: 1812084</a>, Build failure on RTEMS 4.10.2</li>
<li><a href="https://bugs.launchpad.net/bugs/1829919">lp: 1829919</a>, IOC segfaults when calling dbLoadRecords after iocInit</li>
<li><a href="https://bugs.launchpad.net/bugs/1838792">lp: 1838792</a>, epicsCalc bit-wise operators on aarch64</li>
<li><a href="https://bugs.launchpad.net/bugs/1853148">lp: 1853148</a>, mingw compiler problem with printf/scanf formats</li>
<li><a href="https://bugs.launchpad.net/bugs/1852653">lp: 1852653</a>, USE_TYPED_DSET incompatible with C++</li>
<li><a href="https://bugs.launchpad.net/bugs/1862328">lp: 1862328</a>, Race condition on IOC start leaves rsrv unresponsive</li>
<li><a href="https://bugs.launchpad.net/bugs/1866651">lp: 1866651</a>, thread joinable race</li>
<li><a href="https://bugs.launchpad.net/bugs/1868486">lp: 1868486</a>, epicsMessageQueue lost messages</li>
<li><a href="https://bugs.launchpad.net/bugs/1868680">lp: 1868680</a>, Access Security file reload (asInit) fails</li>
</ul>
<h3>*_API macros in EPICS headers</h3>
<p>Internally, the Com and ca libraries now express dllimport/export (Windows) and symbol visibility (GCC) using library-specific macros (eg. <code>LIBCOM_API</code>) instead of the macros <code>epicsShareFunc</code>, <code>epicsShareClass</code>, <code>epicsShareDef</code> etc. that are defined in the <code>shareLib.h</code> header. This change may affect some user code which uses the <code>epicsShare*</code> macros without having explicitly included the <code>shareLib.h</code> header themselves. Such code should be changed to include <code>shareLib.h</code> directly.</p>
<p>A new helper script <code>makeAPIheader.pl</code> and build rules to generate a library-specific <code>*API.h</code> header file has been added. Run <code>makeAPIheader.pl -h</code> for information on how to use this in your own applications, but note that the resulting sources will not be able to be compiled using earlier versions of EPICS Base.</p>
<h3>IOCsh usage messages</h3>
<p>At the iocShell prompt <code>help &lt;cmd&gt;</code> now prints a descriptive usage message for many internal IOCsh commands in addition to the command parameters. Try <code>help *</code> to see all commands, or a glob pattern such as <code>help db*</code> to see a subset.</p>
<p>External code may provide usage messages when registering commands using a new <code>const char *usage</code> member of the <code>iocshFuncDef</code> structure. The <code>iocsh.h</code> header also now defines a macro <code>IOCSHFUNCDEF_HAS_USAGE</code> which can be used to detect Base versions that support this feature at compile-time.</p>
<h3>Variable names in RELEASE files</h3>
<p><code>configure/RELEASE</code> files are parsed by both GNUmake and the <code>convertRelease.pl</code> script. While GNUmake is quite relaxed about what characters may be used in a RELEASE variable name, the <code>convertRelease.pl</code> script parser has only recognized variable names that match the Perl regular expression <code>\w+</code>, i.e. upper and lower-case letters, digits and underscore characters.</p>
<p>The script has been modified so now RELEASE variable names must start with a letter or underscore, and be followed by any number of letters, digits, underscore or hyphen characters, matching the regular expression <code>[A-Za-z_][A-Za-z_0-9-]*</code>. The hyphen character <code>-</code> was not previously allowed and if used would have prevented a build from finding include files and libraries in any module using that in its RELEASE variable name.</p>
<p>This change does disallow names that start with a digit which used to be allowed, but hopefully nobody has been relying on that ability. The regular expression used for names can be found in the file <code>src/tools/EPICS/Release.pm</code> and can be adjusted locally if necessary.</p>
<h3>caRepeater /dev/null</h3>
<p>On *NIX targets caRepeater will now partially daemonize by redirecting stdin/out/err to /dev/null. This prevents caRepeater from inheriting the stdin/out of a process, like caget, which has spawned it in the background. This has been known to cause problems in some cases when caget is itself being run from a shell script.</p>
<p>caRepeater will now understand the <code>-v</code> argument to retain stdin/out/err which may be necessary to see any error messages it may emit.</p>
<h3><code>state</code> record deprecated</h3>
<p>IOCs now emit a warning when a database file containing the <code>state</code> record is loaded. This record has been deprecated for a while and will be removed beginning with EPICS 7.1. Consider using the <code>stringin</code> record instead.</p>
<h3>Record types publish dset's</h3>
<p>The record types in Base now define their device support entry table (DSET) structures in the record header file. While still optional, developers of external support modules are encouraged to start converting their code to use the record's new definitions instead of the traditional approach of copying the structure definitions into each source file that needs them. By following the instructions below it is still possible for the converted code to build and work with older Base releases.</p>
<p>This would also be a good time to modify the device support to use the type-safe device support entry tables that were introduced in Base-3.16.2 &ndash; see [#type-safe-device-and-driver-support-tables](this entry below) for the description of that change, which is also optional for now.</p>
<p>Look at the aiRecord for example. Near the top of the generated <code>aiRecord.h</code> header file is a new section that declares the <code>aidset</code>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Declare Device Support Entry Table */</span></div><div class="line"><span class="keyword">struct </span>aiRecord;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>aidset {</div><div class="line">    dset common;</div><div class="line">    long (*read_ai)(<span class="keyword">struct </span>aiRecord *prec);</div><div class="line">    long (*special_linconv)(<span class="keyword">struct </span>aiRecord *prec, <span class="keywordtype">int</span> after);</div><div class="line">} aidset;</div><div class="line"><span class="preprocessor">#define HAS_aidset</span></div></div><!-- fragment --><p>Notice that the common members (<code>number</code>, <code>report()</code>, <code>init()</code>, <code>init_record()</code> and <code>get_ioint_info()</code> don't appear directly but are included by embedding the <code>dset common</code> member instead. This avoids the need to have separate definitions of those members in each record dset, but does require those members to be wrapped inside another set of braces <code>{}</code> when initializing the data structure for the individual device supports. It also requires changes to code that references those common members, but that code usually only appears inside the record type implementation and very rarely in device supports.</p>
<p>An aiRecord device support that will only be built against this or later versions of EPICS can now declare its dset like this:</p>
<div class="fragment"><div class="line">aidset devAiSoft = {</div><div class="line">    { 6, NULL, NULL, init_record, NULL },</div><div class="line">    read_ai, NULL</div><div class="line">};</div><div class="line">epicsExportAddress(dset, devAiSoft);</div></div><!-- fragment --><p>However most device support that is not built into EPICS itself will need to remain compatible with older EPICS versions, which is why the ai record's header file also declares the preprocessor macro <code>HAS_aidset</code>. This makes it easy to define the <code>aidset</code> in the device support code when it's needed, and not when it's provided in the header:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef HAS_aidset</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>aidset {</div><div class="line">    dset common;</div><div class="line">    long (*read_ai)(aiRecord *prec);</div><div class="line">    long (*special_linconv)(aiRecord *prec, <span class="keywordtype">int</span> after);</div><div class="line">} aidset;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">aidset devAiSoft = {</div><div class="line">    { 6, NULL, NULL, init_record, NULL },</div><div class="line">    read_ai, NULL</div><div class="line">};</div><div class="line">epicsExportAddress(dset, devAiSoft);</div></div><!-- fragment --><p>The above <code>typedef struct</code> declaration was copied directly from the new aiRecord.h file and wrapped in the <code>#ifndef HAS_aidset</code> conditional.</p>
<p>This same pattern should be followed for all record types except for the lsi, lso and printf record types, which have published their device support entry table structures since they were first added to Base but didn't previously embed the <code>dset common</code> member. Device support for these record types therefore can't use the dset name since the new definitions are different from the originals and will cause a compile error, so this pattern should be used instead:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef HAS_lsidset</span></div><div class="line"><span class="keyword">struct </span>{</div><div class="line">    dset common;</div><div class="line">    long (*read_string)(lsiRecord *prec);</div><div class="line">}</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">lsidset</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">devLsiEtherIP = {</div><div class="line">    {5, NULL, lsi_init, lsi_init_record, get_ioint_info},</div><div class="line">    lsi_read</div><div class="line">};</div></div><!-- fragment --><h2>EPICS Release 7.0.3.1</h2>
<p><b>IMPORTANT NOTE:</b> <em>Some record types in this release will not be compatible with device support binaries compiled against earlier versions of those record types, because importing the record documentation from the EPICS Wiki <a href="#imported-record-reference-documentation-from-wiki">as described below</a> also modified the order of some of the fields in the record definitions.</em> As long as all support modules and IOCs are rebuilt from source after updating them to use this release of EPICS Base, these changes should not have any affect.</p>
<h3>logClient reliability</h3>
<p>On supported targets (Linux, Mac, Windows) logClient will attempt to avoid dropping undelivered log messages when the connection to the log server is closed/reset.</p>
<h3>Timers and delays use monotonic clock</h3>
<p>Many internal timers and delay calculations use a monotonic clock epicsTimeGetMonotonic() instead of the realtime epicsTimeGetCurrent(). This is intended to make IOCs less susceptible to jumps in system time.</p>
<h3>Iocsh <code>on error ...</code></h3>
<p>A new statement is added to enable IOC shell commands to signal error conditions, and for scripts to respond. This first is through the new function</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> iocshSetError(<span class="keywordtype">int</span> err);</div></div><!-- fragment --><p>A script may be prefixed with eg. "on error break" to stop at the failed command.</p>
<div class="fragment"><div class="line">on error continue | break | wait [value] | halt</div></div><!-- fragment --><p>A suggested form for IOC shell commands is:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> doSomethingCallFunc(<span class="keyword">const</span> iocshArgBuf *args)</div><div class="line">{</div><div class="line">    iocshSetError(doSomething(...)); <span class="comment">/* return 0 == success */</span></div><div class="line">}</div></div><!-- fragment --><h3>Relocatable Builds</h3>
<p>Allows built trees to be copied or moved without invalidating RPATH entires.</p>
<p>The <code>LINKER_USE_RPATH</code> Makefile variable (see <code>configure/CONFIG_SITE</code>) may be set to <code>YES</code>, <code>NO</code>, and a new third option <code>ORIGIN</code>. This is limited to targets using the ELF executable format (eg. Linux).</p>
<p>When <code>LINKER_USE_RPATH=ORIGIN</code>, the variable <code>LINKER_ORIGIN_ROOT</code> is set to one of the parents of the build directory. Any libraries being linked to which are found under this root will have a relative RPATH entry. Other libraries continue to result in absolute RPATH entries.</p>
<p>An effect of this might change a support library from being linked with <code>-Wl,-rpath /build/epics-base/lib/linux-x86</code> to being linked with <code>-Wl,-rpath \$ORIGIN/../../../epics-base/lib/linux-x86</code> if the support module directory is <code>/build/mymodule</code> and <code>LINKER_ORIGIN_ROOT=/build</code>.</p>
<p>The API functions <code>epicsGetExecDir()</code> and <code>epicsGetExecName()</code> are also added to <code>osiFileName.h</code> to provide runtime access to the directory or filename of the executable with which the process was started.</p>
<h3>Decouple LINKER_USE_RPATH and STATIC_BUILD</h3>
<p>Previously, setting <code>STATIC_BUILD=NO</code> implied <code>LINKER_USE_RPATH=NO</code>. This is no longer the case. Setting <code>LINKER_USE_RPATH=YES</code> will always emit RPATH entries. This was found to be helpful when linking against some 3rd party libraries which are only available as shared objects.</p>
<h3>Channel Access Security: Check Hostname Against DNS</h3>
<p>Host names given in a <code>HAG</code> entry of an IOC's Access Security Configuration File (ACF) have to date been compared against the hostname provided by the CA client at connection time, which may or may not be the actual name of that client. This allows rogue clients to pretend to be a different host, and the IOC would believe them.</p>
<p>An option is now available to cause an IOC to ask its operating system to look up the IP address of any hostnames listed in its ACF (which will normally be done using the DNS or the <code>/etc/hosts</code> file). The IOC will then compare the resulting IP address against the client's actual IP address when checking access permissions at connection time. This name resolution is performed at ACF file load time, which has a few consequences:</p>
<ol type="1">
<li>If the DNS is slow when the names are resolved this will delay the process of loading the ACF file.</li>
<li>If a host name cannot be resolved the IOC will proceed, but this host name will never be matched.</li>
<li>Any changes in the hostname to IP address mapping will not be picked up by the IOC unless and until the ACF file gets reloaded.</li>
</ol>
<p>Optionally, IP addresses may be added instead of, or in addition to, host names in the ACF file.</p>
<p>This feature can be enabled before <code>iocInit</code> with</p>
<div class="fragment"><div class="line">var(&quot;asCheckClientIP&quot;,1)</div></div><!-- fragment --><p>or with the VxWorks target shell use</p>
<div class="fragment"><div class="line">asCheckClientIP = 1</div></div><!-- fragment --><h3>New and modified epicsThread APIs</h3>
<h4><code>epicsThreadCreateOpt()</code></h4>
<p>A new routine <code>epicsThreadCreateOpt()</code> is an alternative to <code>epicsThreadCreate()</code> which takes some arguments via a structure (<code>struct epicsThreadOpts</code>) to allow for future extensions.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>epicsThreadOpts {</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> priority;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stackSize;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> joinable;</div><div class="line">} epicsThreadOpts;</div><div class="line"><span class="preprocessor">#define EPICS_THREAD_OPTS_INIT { \</span></div><div class="line"><span class="preprocessor">    epicsThreadPriorityLow, epicsThreadStackMedium, 0}</span></div><div class="line"> epicsThreadId epicsThreadCreateOpt(<span class="keyword">const</span> <span class="keywordtype">char</span> * name,</div><div class="line">    EPICSTHREADFUNC funptr, <span class="keywordtype">void</span> * parm, <span class="keyword">const</span> epicsThreadOpts *opts);</div></div><!-- fragment --><p>The final <code>opts</code> parameter may be <code>NULL</code> to use the default values of thread priority (low) and stack size (medium). Callers wishing to provide alternative settings for these thread options or to create a joinable thread (see below) should create and pass in an <code>epicsThreadOpts</code> structure as shown below. Always initialize one of these structures using the <code>EPICS_THREAD_OPTS_INIT</code> macro to ensure that any additional fields that get added in the future are set to their default values.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> startitup(<span class="keywordtype">void</span>) {</div><div class="line">    epicsThreadOpts opts = EPICS_THREAD_OPTS_INIT;</div><div class="line">    epicsThreadId tid;</div><div class="line"></div><div class="line">    opts.priority = epicsThreadPriorityMedium;</div><div class="line">    tid = epicsThreadCreateOpt(<span class="stringliteral">&quot;my thread&quot;</span>, &amp;threadMain, NULL, &amp;opts);</div><div class="line">}</div></div><!-- fragment --><p>C or C++ Code that also needs to build on earlier versions of Base can use <code>#ifdef EPICS_THREAD_OPTS_INIT</code> to determine whether the <code>epicsThreadCreateOpt()</code> API is available on this Base version.</p>
<h4>Thread stack sizes</h4>
<p>The <code>stackSize</code> member of the <code>epicsThreadOpts</code> structure and the equivalent parameters to the <code>epicsThreadCreate()</code> and <code>epicsThreadMustCreate()</code> routines can now be passed either one of the <code>epicsThreadStackSizeClass</code> enum values or a value returned from the <code>epicsThreadGetStackSize()</code> routine.</p>
<h4><code>epicsThreadMustJoin()</code></h4>
<p>If the new <code>joinable</code> flag of an <code>epicsThreadOpts</code> structure is non-zero (the default value is zero), the new API routine <code>epicsThreadMustJoin()</code> <em>must</em> be called with the thread's <code>epicsThreadId</code> when/after the thread exits, to free up thread resources. This function will block until the thread's main function has returned, allowing the parent to wait for its child thread. The child's <code>epicsThreadId</code> will no longer be valid and should not be used after the <code>epicsThreadMustJoin()</code> routine returns.</p>
<p>A thread that was originally created with its joinable flag set may itself call <code>epicsThreadMustJoin()</code>, passing in its own epicsThreadId. This marks the thread as no longer being joinable, so it will then free the thread resources itself when its main function returns. The <code>epicsThreadId</code> of a thread that is not joinable gets invalidated as soon as its main function returns.</p>
<h3>Non-VME RTEMS targets now define pdevLibVME</h3>
<p>Previously IOC executables that made calls to devLib routines would fail to link when built for some non-VME based RTEMS targets, which would have to be explicitly filtered out by sites that build Base for those targets. <a href="https://bugs.launchpad.net/epics-base/+bug/1841692">This fix</a> makes that no longer necessary, all RTEMS targets should now link although the IOC won't be able to be used with the VME I/O on those systems (that we don't have VMEbus I/O support for in libCom).</p>
<h2>EPICS Release 7.0.3</h2>
<h3><code>epicsTimeGetCurrent()</code> optimization</h3>
<p>Add a fast path to epicsTimeGetCurrent() and related calls in the common case where only the default OS current time provider is registered. This path does not take the global mutex guarding the time providers list, potentially reducing lock contention.</p>
<h3>dbEvent tweak Queue size</h3>
<p>The size of the queue used by dbEvent to push monitor updates has been slightly increased based on <code>DBR_TIME_DOUBLE</code> to better fill an ethernet frame. This may result in slightly fewer, but larger frames being sent.</p>
<h3>mbbo/mbbiDirect number of bits as precision</h3>
<p>Report NOBT as "precision" through the dbAccess API. This is not accessible through CA, but is planned to be used through QSRV.</p>
<h2>EPICS Release 7.0.2.2</h2>
<h3>Build System changes</h3>
<ul>
<li>The GNUmake build targets <code>cvsclean</code> and <code>depclean</code> are now available from any directory; previously they were only available from application top directories.</li>
<li>The approach that EPICS Base uses for building submodules inside the parent module looks useful for support modules too. The rules for building submodules have been modified and extracted into a new <code>RULES_MODULES</code> file, so a support module will be able to use them too without having to copy them into its own <code>modules/Makefile</code>. There are some specific requirements that support modules and their submodules must follow, which are described as comments in the new <code>base/configure/RULES_MODULES</code> file itself.</li>
</ul>
<h3><code>EPICS_BASE_VERSION</code> Update Policy change</h3>
<p>In the past, a build of EPICS using sources checked out from the repository branch between official releases would have shown the version number of the previous release, followed by a -DEV suffix, for example 7.0.2.1-DEV.</p>
<p>The policy that controls when the number gets updated has been changed, and now immediately after a release has been tagged the version number will be updated to the next patch release version, plus the -DEV suffix as before. Thus following 7.0.2.2 the version number will show as 7.0.2.3-DEV. This does not require the next official release to be numbered 7.0.2.3 though, it could become 7.0.3 or even 7.1.0 if the changes incorporated into it are more substantial than bug fixes.</p>
<h3>Drop <code>CLOCK_MONOTONIC_RAW</code> from posix/osdMonotonic.c</h3>
<p>Turns out this is ~10x slower to query than <code>CLOCK_MONOTONIC</code>.</p>
<h2>EPICS Release 7.0.2.1</h2>
<h3>Linking shared libraries on macOS</h3>
<p>The linker flag <code>-flat_namespace</code> has been restored for creating shared libraries, although not for loadable libraries (bundles). This was required for building using the latest versions of Apple XCode.</p>
<h3>Fix <code>DB_LINK</code> loop breaking</h3>
<p>A regression was introduced in 7.0.2 which caused record chains with loops to be incorrectly broken. Processing should be skipped when a <code>DB_LINK</code> with Process Passive (PP) closes a loop to a synchronous record.</p>
<p>Instead in 7.0.2 the targeted record would be processed if processing began with a remote action (or some other caller of <code>dbPutField()</code>). This would result in the loop running a second time. The loop would be broken on the second iteration.</p>
<p><a href="https://bugs.launchpad.net/epics-base/+bug/1809570">See lp: #1809570</a></p>
<h3>Old dbStaticLib APIs removed</h3>
<p>Support for some obsolete dbStaticLib Database Configuration Tool (DCT) APIs was removed some time ago, but vestiges of them still remained. The following routines and macros and have now finally been removed:</p>
<ul>
<li><code>int dbGetFieldType(DBENTRY *pdbentry)</code></li>
<li><code>int dbGetLinkType(DBENTRY *pdbentry)</code></li>
<li><code>DCT_STRING</code></li>
<li><code>DCT_INTEGER</code></li>
<li><code>DCT_REAL</code></li>
<li><code>DCT_MENU</code></li>
<li><code>DCT_MENUFORM</code></li>
<li><code>DCT_INLINK</code></li>
<li><code>DCT_OUTLINK</code></li>
<li><code>DCT_FWDLINK</code></li>
<li><code>DCT_NOACCESS</code></li>
<li><code>DCT_LINK_CONSTANT</code></li>
<li><code>DCT_LINK_FORM</code></li>
<li><code>DCT_LINK_PV</code></li>
</ul>
<h3>Fix for <code>dbhcr</code> before <code>iocInit</code></h3>
<p>The <code>dbhcr</code> command used to work before <code>iocInit</code> as well as afterwards. It displays all records that have hardware addresses (<code>VME_IO</code>, <code>CAMAC_IO</code>, <code>GPIB_IO</code>, <code>INST_IO</code> etc.) but stopped working if run before iocInit due to the rewrite of the link address parser code in dbStaticLib. This release fixes that issue, although in some cases the output may be slightly different than it used to be.</p>
<h2>EPICS Release 7.0.2</h2>
<h3>Launchpad Bugs</h3>
<p>The list of tracked bugs fixed in this release can be found on the <a href="https://launchpad.net/epics-base/+milestone/7.0.2">Launchpad Milestone page for EPICS Base 7.0.2</a>.</p>
<h3>Git Branches Recombined</h3>
<p>The four separate Git branches <code>core/master</code>, <code>libcom/master</code>, <code>ca/master</code> and <code>database/master</code> have been recombined into one branch called <code>7.0</code>. Keeping these as 4 separate branches in the same repository made it impossible to create merge requests that contained changes in more than one of these modules. The layout of the source files has not changed at all however, so the source code for libcom, ca and the database are still found separately under the module subdirectory.</p>
<h2>EPICS Release 7.0.1.1</h2>
<h3>Changed SIML failure behavior</h3>
<p>A failure when fetching the simulation mode through <code>SIML</code> will not put the record into INVALID alarm state anymore. Instead, as long as the record's current alarm severity (<code>SEVR</code>)is <code>NO_ALARM</code>, its alarm status (<code>STAT</code>) will be set to <code>LINK_ALARM</code> without increasing the severity. This allows clients to get some notification of a failing or bad <code>SIML</code> link without otherwise affecting record processing.</p>
<h3><code>dbVerify()</code> has been restored to dbStaticLib</h3>
<p>This routine was removed in Base-3.16.1 but has been reimplemented in this release by special request. Note that the error message strings that it returns when verification fails have changed, but are still designed for display to the user.</p>
<h3>Simulation mode improvements</h3>
<p>Records that support simulation mode have two new fields, <code>SSCN</code> (Simulation Scan Mode) and <code>SDLY</code> (Simulation Delay). <code>SSCN</code> is a menu field that provides an alternate value for the <code>SCAN</code> field to be used while the record is in simulation mode. This is especially useful for I/O scanned records, for which simulation mode was not working at all. Setting <code>SDLY</code> to a positive value makes the record process asynchronously in simulation mode, with the second stage processing happening after the specified time (in seconds).</p>
<h3>Extend the dbServer API with init/run/pause/stop methods</h3>
<p>This change permits IOCs to be built that omit the CA server (RSRV) by removing its registrar entry which is now provided in the new <code>rsrv.dbd</code> file. Other server layers can be built into the IOC (alongside RSRV or in place of it) by registering them in a similar manner. The dbServer API is documented with Doxygen comments in the header file.</p>
<p>Specific IOC server layers can be disabled at runtime by adding their name to the environment variable <code>EPICS_IOC_IGNORE_SERVERS</code> (separated by spaces if more than one should be ignored).</p>
<h3>Grand source-code reorganization</h3>
<p>EPICS 7.0.1 contains the IOC Database, RSRV server and the Channel Access client code from EPICS Base 3.16.1 along with all the original record types and soft device support, but GDD and the Portable Channel Access Server have been unbundled and are now available separately. In their place we have brought in the more recently written EPICS V4 C++ libraries (collectively referred to as the PVA modules). The directory tree for EPICS is somewhat larger as a result, and the original structure of the Base directories has been split into 4 separate Git repositories. External modules should build against this new structure with little or no changes needed, except that some allowance may be needed for the merging of the V4 modules.</p>
<p>There should be rather more description and documantation of these changes than is currently available, but as developers we generally much prefer to write code than documentation. Send questions to the tech-talk mailing list and we'll be happy to try and answer them!</p>
<h2>Changes between 3.16.1 and 3.16.2</h2>
<p>The list of tracked bugs fixed in this release can be found on the <a href="https://launchpad.net/epics-base/+milestone/3.16.2">Launchpad Milestone page for EPICS Base 3.16.2</a>.</p>
<h3>Status reporting for the callback and scanOnce task queues</h3>
<p>Two new iocsh commands and some associated underlying APIs have been added to show the state of the queues that feed the three callback tasks and the scanOnce task, including a high-water mark which can optionally be reset. The new iocsh commands are <code>callbackQueueShow</code> and <code>scanOnceQueueShow</code>; both take an optional integer argument which must be non-zero to reset the high-water mark.</p>
<h3>Support for event codes greater than or equal to <code>NUM_TIME_EVENTS</code></h3>
<p>Event numbers greater than or equal to <code>NUM_TIME_EVENTS</code> are now allowed if supported by the registered event time provider, which must provide its own advancing timestamp validation for such events.</p>
<p>Time events numbered 0 through <code>(NUM_TIME_EVENTS-1)</code> are still validated by code in epicsGeneralTime.c that checks for advancing timestamps and enforces that restriction.</p>
<h3>Type-safe Device and Driver Support Tables</h3>
<p>Type-safe versions of the device and driver support structures <code>dset</code> and <code>drvet</code> have been added to the devSup.h and drvSup.h headers respectively. The original structure definitions have not been changed so existing support modules will still build normally, but older modules can be modified and new code written to be compatible with both.</p>
<p>The old structure definitions will be replaced by the new ones if the macros <code>USE_TYPED_DSET</code> and/or <code>USE_TYPED_DRVET</code> are defined when the appropriate header is included. The best place to define these is in the Makefile, as with the <code>USE_TYPED_RSET</code> macro that was introduced in Base-3.16.1 and described below. See the comments in devSup.h for a brief usage example, or look at <a href="https://github.com/epics-modules/ipac/commit/a7e0ff4089b9aa39108bc8569e95ba7fcf07cee9">this commit</a> to the ipac module to see a module conversion.</p>
<p>A helper function <code>DBLINK* dbGetDevLink(dbCommon *prec)</code> has also been added to devSup.h which fetches a pointer to the INP or OUT field of the record.</p>
<h3>RTEMS build configuration update, running tests under QEMU</h3>
<p>This release includes the ability to run the EPICS unit tests built for a special version of the RTEMS-pc386 target architecture on systems that have an appropriate QEMU emulator installed (<code>qemu-system-i386</code>). It is also now possible to create sub-architectures of RTEMS targets, whereas previously the EPICS target architecture name had to be <code>RTEMS-</code>.</p>
<p>The new target <code>RTEMS-pc386-qemu</code> builds binaries that can be run in the <code>qemu-system-i386</code> PC System emulator. This target is a derivative of the original <code>RTEMS-pc386</code> target but with additional software to build an in- memory file-system, and some minor modifications to allow the unit tests to work properly under QEMU. When this target is enabled, building any of the make targets that cause the built-in self-tests to be run (such as <code>make runtests</code>) will also run the tests for RTEMS using QEMU.</p>
<p>To allow the new 3-component RTEMS target name, the EPICS build system for RTEMS was modified to allow a <code>configure/os/CONFIG.Common.&lt;arch&gt;</code> file to set the <code>RTEMS_BSP</code> variable to inform the build what RTEMS BSP to use. Previously this was inferred from the value of the <code>T_A</code> make variable, but that prevents having multiple EPICS targets that build against the same BSP. All the included RTEMS target configuration files have been updated; build configuration files for out-of-tree RTEMS targets will continue to work as the original rules are used to set <code>RTEMS_BSP</code> if it hasn't been set when needed.</p>
<h3>Link type enhancements</h3>
<p>This release adds three new link types: "state", "debug" and "trace". The "state" link type gets and puts boolean values from/to the dbState library that was added in the 3.15.1 release. The "debug" link type sets the <code>jlink::debug</code> flag in its child link, while the "trace" link type also causes the arguments and return values for all calls to the child link's jlif and lset routines to be printed on stdout. The debug flag can no longer be set using an info tag. The addition of the "trace" link type has allowed over 200 lines of conditional diagnostic printf() calls to be removed from the other link types.</p>
<p>The "calc" link type can now be used for output links as well as input links. This allows modification of the output value and even combining it with values from other input links. See the separate JSON Link types document for details.</p>
<p>A new <code>start_child()</code> method was added to the end of the jlif interface table.</p>
<p>The <code>lset</code> methods have now been properly documented in the dbLink.h header file using Doxygen annotations, although we do not run Doxygen on the source tree yet to generate API documentation.</p>
<p>Link types that utilize child links must now indicate whether the child will be used for input, output or forward linking by the return value from its <code>parse_start_map()</code> method. The <code>jlif_key_result</code> enum now contains 3 values <code>jlif_key_child_inlink</code>, <code>jlif_key_child_outlink</code> and <code>jlif_key_child_fwdlink</code> instead of the single <code>jlif_key_child_link</code> that was previously used for this.</p>
<h3>GNUmake targets for debugging</h3>
<p>Some additional build rules have been added to help debug configuration problems with the build system. Run <code>make show-makefiles</code> to get a sorted list of all the files that the build system includes when building in the current directory.</p>
<p>A new pattern rule for <code>PRINT.%</code> can be used to show the value of any GNUmake variable for the current build directory (make sure you are in the right directory though, many variables are only set when inside the <code>O.&lt;arch&gt;</code> build directory). For example <code>make PRINT.T_A</code> will display the build target architecture name from inside a <code>O.&lt;arch&gt;</code> directory but the variable will be empty from an application top or src directory. <code>make PRINT.EPICS_BASE</code> will show the path to Base from any EPICS application directory though.</p>
<h3>Propagate PUTF across Asynchronous record processing</h3>
<p>The IOC contains a mechanism involving the PUTF and RPRO fields of each record to ensure that if a record is busy when it receives a put to one of its fields, the record will be processed again to ensure that the new field value has been correctly acted on. Until now that mechanism only worked if the put was to the asynchronous record itself, so puts that were chained from some other record via a DB link did not cause reprocessing.</p>
<p>In this release the mechanism has been extended to propagate the PUTF state across DB links until all downstream records have been reprocessed. Some additional information about the record state can be shown by setting the TPRO field of an upstream record, and even more trace data is displayed if the debugging variable <code>dbAccessDebugPUTF</code> is set in addition to TPRO.</p>
<h3>Finding info fields</h3>
<p>A new iocsh command <code>dbli</code> lists the info fields defined in the database, and can take a glob pattern to limit output to specific info names. The newly added dbStaticLib function <code>dbNextMatchingInfo()</code> iterates through the info fields defined in the current record, and is used to implement the new command.</p>
<h3>Output from <code>dbpr</code> command enhanced</h3>
<p>The "DataBase Print Record" command <code>dbpr</code> now generates slightly better output, with more field types having their own display methods. This release also includes additional protection against buffer overflows while printing long links in <code>dbpr</code>, and corrects the output of long strings from the <code>dbgf</code> command.</p>
<h3>Record types mbbiDirect and mbboDirect upgraded to 32 bit</h3>
<p>The VAL fields and related fields of these records are now <code>DBF_LONG</code>. (Not <code>DBF_ULONG</code> in order to prevent Channel Access from promoting them to <code>DBF_DOUBLE</code>.) Additional bit fields <code>B10</code>...<code>B1F</code> have been added.</p>
<p>Device support that accesses <code>VAL</code> or the bit fields directly (most don't) and aims for compatibility with old and new versions of these records should use at least 32 bit integer types to avoid bit loss. The number of bit fields can be calculated using <code>8 * sizeof(prec-&gt;val)</code> which is correct in both versions.</p>
<h3>Restore use of ledlib for VxWorks command editing</h3>
<p>The epicsReadline refactoring work described below unfortunately disabled the VxWorks implementation of the osdReadline.c API that uses ledlib for command editing and history. This functionality has now been restored, see Launchpad <a href="https://bugs.launchpad.net/bugs/1741578">bug #1741578</a>.</p>
<h3>Constant link types</h3>
<p>Constant links can now hold 64-bit integer values, either as scalars or arrays. Only base 10 is supported by the JSON parser though, the JSON standard doesn't allow for hexadecimal numbers.</p>
<h3>Upgraded the YAJL JSON Library</h3>
<p>The third-party YAJL library that has been included in libCom for several years has been upgraded to version 2.1.0 and several bugs fixed. This has an updated API, requiring any code that uses it to parse its own JSON files to be modified to match. The changes are mainly that it uses <code>size_t</code> instead <code>unsigned int</code> for string lengths, but it also uses <code>long long</code> instead of <code>long</code> for JSON integer values, which was the main motivation for the upgrade.</p>
<p>The self-tests that YAJL comes with have been imported and are now run as an EPICS Unit Test program, and the JSON syntax accepted by the parser was extended to permit trailing commas in both arrays and maps. The difference between the old and new YAJL APIs can be detected at compile time by looking for the macro <code>EPICS_YAJL_VERSION</code> which is defined in the <code>yajl_common.h</code> header file along with a brief description of the API changes.</p>
<h3>Timestamp support for the calc link type</h3>
<p>A new optional parameter can be given when specifying a calc JSON link. The <code>time</code> parameter is a string containing a single letter <code>A..L</code> that selects one of the input links to be used for the timestamp of calculation if requested. The timestamp will be fetched atomically with the value from the chosen input link (providing that input link type supports the readLocked() method).</p>
<h3>Silence errors from puts to constant link types</h3>
<p>A soft channel output record with the OUT link unset uses the CONSTANT link type. The new link type code was causing some soft channel device supports to return an error status from the write method of that link type, which would cause a <code>ca_put()</code> operation to such a record to generate an exception. This has been silenced by giving the constant link types a dummy putValue method. A new test program has been added to prevent regressions of this behaviour.</p>
<h3>RSRV expanding large buffer causes crash</h3>
<p>In the 3.16.1 release a crash can occur in the IOC's RSRV server when a large array is made even larger; the previous array buffer was not being released correctly. See Launchpad <a href="https://bugs.launchpad.net/epics-base/+bug/1706703">bug #1706703</a>.</p>
<h2>Changes made between 3.16.0.1 and 3.16.1</h2>
<h3>IOC Database Support for 64-bit integers</h3>
<p>The IOC now supports the 64-bit integer field types <code>DBF_INT64</code> and <code>DBF_UINT64</code>, and there are new record types <code>int64in</code> and <code>int64out</code> derived from the <code>longin</code> and <code>longout</code> types respectively that use the <code>DBF_INT64</code> data type for their VAL and related fields. The usual range of Soft Channel device support are included for these new record types.</p>
<p>All internal IOC APIs such as dbAccess can handle the new field types and their associated request values <code>DBR_INT64</code> and <code>DBR_UINT64</code>, which are implemented using the <code>epicsInt64</code> and <code>epicsUInt64</code> typedef's from the <code>epicsTypes.h</code> header.</p>
<p>The waveform record type has been updated to support these new field types. <b>All waveform device support layers must be updated to recognize the new type enumeration values</b>, which had to be inserted before the <code>FLOAT</code> value in the enum <code>dbfType</code> and in <code>menuFtype</code>. C or C++ code can detect at compile-time whether this version of base provides 64-bit support by checking for the presence of the <code>DBR_INT64</code> macro as follows (Note that <code>DBF_INT64</code> is an enum tag and not a preprocessor macro):</p>
<div class="fragment"><div class="line">#ifdef DBR_INT64</div><div class="line">    /* Code where Base has INT64 support */</div><div class="line">#else</div><div class="line">    /* Code for older versions */</div><div class="line">#endif</div></div><!-- fragment --><p>If the code uses the old <code>db_access.h</code> types (probably because it's calling Channel Access APIs) then it will have to test against the EPICS version number instead, like this:</p>
<div class="fragment"><div class="line">#include &lt;epicsVersion.h&gt;</div><div class="line"></div><div class="line">#ifndef VERSION_INT</div><div class="line">#  define VERSION_INT(V,R,M,P) ( ((V)&lt;&lt;24) | ((R)&lt;&lt;16) | ((M)&lt;&lt;8) | (P))</div><div class="line">#endif</div><div class="line">#ifndef EPICS_VERSION_INT</div><div class="line">#  define EPICS_VERSION_INT VERSION_INT(EPICS_VERSION, EPICS_REVISION, EPICS_MODIFICATION, EPICS_PATCH_LEVEL)</div><div class="line">#endif</div><div class="line"></div><div class="line">#if EPICS_VERSION_INT &gt;= VERSION_INT(3,16,1,0)</div><div class="line">    /* Code where Base has INT64 support */</div><div class="line">#else</div><div class="line">    /* Code for older versions */</div><div class="line">#endif</div></div><!-- fragment --><p>Channel Access does not (and probably never will) directly support 64-bit integer types, so the new field types are presented to the CA server as <code>DBF_DOUBLE</code> values. This means that field values larger than 2^52 (0x10_0000_0000_0000 = 4503599627370496) cannot be transported over Channel Access without their least significant bits being truncated. The EPICS V4 pvAccess network protocol <em>can</em> transport 64-bit data types however, and a future release of the pvaSrv module will connect this ability to the fields of the IOC.</p>
<p>Additional 64-bit support will be provided in later release. For instance the JSON parser for the new Link Support feature only handles integers up to 32 bits wide, so constant array initializer values cannot hold larger values in this release.</p>
<h3>Add <code>EPICS_CA_MCAST_TTL</code></h3>
<p>A new environment parameter <code>EPICS_CA_MCAST_TTL</code> is used to set the Time To Live (TTL) value of any IP multi-cast CA search or beacon packets sent.</p>
<h3><code>EPICS_CA_MAX_ARRAY_BYTES</code> is optional</h3>
<p>A new environment parameter <code>EPICS_CA_AUTO_ARRAY_BYTES</code> is now used by libca and RSRV (CA clients and the IOC CA server). The default is equivalent to setting <code>EPICS_CA_AUTO_ARRAY_BYTES=YES</code> which removes the need to set <code>EPICS_CA_MAX_ARRAY_BYTES</code> and always attempts to allocate sufficiently large network buffers to transfer large arrays properly over the network. In this case the value of the <code>EPICS_CA_MAX_ARRAY_BYTES</code> parameter is ignored.</p>
<p>Explicitly setting <code>EPICS_CA_AUTO_ARRAY_BYTES=NO</code> will continue to honor the buffer setting in <code>EPICS_CA_AUTO_ARRAY_BYTES</code> as in previous releases.</p>
<p>The default setting for <code>EPICS_CA_AUTO_ARRAY_BYTES</code> can be changed by adding the line</p>
<div class="fragment"><div class="line">EPICS_CA_AUTO_ARRAY_BYTES=NO</div></div><!-- fragment --><p>to the <code>configure/CONFIG_SITE_ENV</code> file before building Base. Sites that wish to override this only for specific IOC architectures can create new files for each architecture named <code>configure/os/CONFIG_SITE_ENV.&lt;target-arch&gt;</code> with the above setting in before building Base. The configuration can also be explicitly changed by setting the environment variable in the IOC's startup script, anywhere above the <code>iocInit</code> line.</p>
<p>The PCAS server (used by the PV Gateway and other CA servers) now always behaves as if <code>EPICS_CA_AUTO_ARRAY_BYTES</code> is set to <code>YES</code> (it ignores the configuration parameter and environment variable).</p>
<h3>Channel Access "modernization"</h3>
<p>Drop support for CA clients advertising protocol versions less than 4.</p>
<p>This effects clients from Base older than 3.12.0-beta1. Newer clients will continue to be able to connect to older servers. Older clients will be ignored by newer servers.</p>
<p>This allows removal of UDP echo and similar protocol features which are not compatible with secure protocol design practice.</p>
<h3>Lookup-tables using the subArrray record</h3>
<p>The subArray record can now be used as a lookup-table from a constant array specified in its INP field. For example:</p>
<div class="fragment"><div class="line">record(subArray, &quot;powers-of-2&quot;) {</div><div class="line">  field(FTVL, &quot;LONG&quot;)</div><div class="line">  field(MALM, 12)</div><div class="line">  field(INP, [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048])</div><div class="line">  field(INDX, 0)</div><div class="line">  field(NELM, 1)</div><div class="line">}</div></div><!-- fragment --><p>The INDX field selects which power of 2 to set the VAL field to. In previous releases the INP field would have to have been pointed to a separate waveform record that was initialized with the array values somehow at initialization time.</p>
<h3>Synchronized Timestamps with TSEL=-2</h3>
<p>Most Soft Channel input device support routines have supported fetching the timestamp through the INP link along with the input data. However before now there was no guarantee that the timestamp provided by a CA link came from the same update as the data, since the two were read from the CA input buffer at separate times without maintaining a lock on that buffer in between. This shortcoming could be fixed as a result of the new link support code, which allows code using a link to pass a subroutine to the link type which will be run with the link locked. The subroutine may make multiple requests for metadata from the link, but must not block.</p>
<h3>Extensible Link Types</h3>
<p>A major new feature introduced with this release of EPICS Base is an Extensible Link Type mechanism, also known as Link Support or JSON Link Types. This addition permits new kinds of link I/O to be added to an IOC in a similar manner to the other extension points already supported (e.g. record, device and driver support).</p>
<p>A new link type must implement two related APIs, one for parsing the JSON string which provides the link address and the other which implements the link operations that get called at run-time to perform I/O. The link type is built into the IOC by providing a new <code>link</code> entry in a DBD file.</p>
<h4>New Link Types Added</h4>
<p>This release contains two new JSON link types, <code>const</code> and <code>calc</code>:</p>
<ul>
<li>The <code>const</code> link type is almost equivalent to the old CONSTANT link type with the updates described below to accept arrays and strings, except that there is no need to wrap a scalar string constant inside array brackets since a constant string will never be confused with a PV name.</li>
<li>The <code>calc</code> link type allows CALC expressions to be used to combine values from other JSON links to produce its value. Until additional JSON link types are created though, the <code>calc</code> link type has little practical utility as it can currently only fetch inputs from other <code>calc</code> links or from <code>const</code> links.</li>
</ul>
<div class="fragment"><div class="line">field(INP, {calc:{expr:&quot;A+B+1&quot;,</div><div class="line">                  args:[5,         # A</div><div class="line">                        {const:6}] # B</div><div class="line">                 }</div><div class="line">           }</div><div class="line">       )</div></div><!-- fragment --><p>The new link types are documented in a separate document that gets generated at build time and installed as <code>html/links.html</code>.</p>
<h4>Device Support Addressing using <code>JSON_LINK</code></h4>
<p>The API to allow device support to use JSON addresses is currently incomplete; developers are advised not to try creating device support that specifies a <code>JSON_LINK</code> address type.</p>
<h4>Support Routine Modifications for Extensible Link Types</h4>
<p>For link fields in external record types and soft device support to be able to use the new link types properly, various changes are required to utilize the new Link Support API as defined in the dbLink.h header file and outlined below. The existing built-in Database and Channel Access link types have been altered to implement the link APIs, so will work properly after these conversions:</p>
<ul>
<li>Make all calls to <code>recGblInitConstantLink()</code> unconditional on the link type, i.e. change this code:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (prec-&gt;siml.type == CONSTANT) {</div><div class="line">    recGblInitConstantLink(&amp;prec-&gt;siml, DBF_USHORT, &amp;prec-&gt;simm);</div><div class="line">}</div></div><!-- fragment --><p>into this:</p>
<div class="fragment"><div class="line">recGblInitConstantLink(&amp;prec-&gt;siml, DBF_USHORT, &amp;prec-&gt;simm);</div></div><!-- fragment --><p>Note that <code>recGblInitConstantLink()</code> still returns TRUE if the field was successfully initialized from the link (implying the link is constant). This change will work properly with all Base releases currently in use.</p>
<ul>
<li>Code that needs to identify a constant link should be modified to use the new routine <code>dbLinkIsConstant()</code> instead, which returns TRUE for constant or undefined links, FALSE for links whose <code>dbGetLink()</code> routine may return different values on different calls. For example this:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (prec-&gt;dol.type != CONSTANT)</div></div><!-- fragment --><p>should become this:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (!dbLinkIsConstant(&amp;prec-&gt;dol))</div></div><!-- fragment --><p>When the converted software is also required to build against older versions of Base, this macro definition may be useful:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define dbLinkIsConstant(lnk) ((lnk)-&gt;type == CONSTANT)</span></div></div><!-- fragment --><ul>
<li>Any code that calls dbCa routines directly, or that explicitly checks if a link has been resolved as a CA link using code such as</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (prec-&gt;inp.type == CA_LINK)</div></div><!-- fragment --><p>will still compile and run, but will only work properly with the old CA link type. To operate with the new extensible link types such code must be modified to use the new generic routines defined in dbLink.h and should never attempt to examine or modify data inside the link. After conversion the above line would probably become:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (dbLinkIsVolatile(&amp;prec-&gt;inp))</div></div><!-- fragment --><p>A volatile link is one like a Channel Access link which may disconnect and reconnect without notice at runtime. Database links and constant links are not volatile; unless their link address is changed they will always remain in the same state they started in. For compatibility when building against older versions of Base, this macro definition may be useful:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define dbLinkIsVolatile(lnk) ((lnk)-&gt;type == CA_LINK)</span></div></div><!-- fragment --><ul>
<li>The current connection state of a volatile link can be found using the routine <code>dbIsLinkConnected()</code> which will only return TRUE for a volatile link that is currently connected. Code using the older dbCa API returning this information used to look like this:</li>
</ul>
<div class="fragment"><div class="line">stat = dbCaIsLinkConnected(plink);</div></div><!-- fragment --><p>which should become:</p>
<div class="fragment"><div class="line">stat = dbIsLinkConnected(plink);</div></div><!-- fragment --><p>Similar changes should be made for calls to the other dbCa routines.</p>
<ul>
<li>A full example can be found by looking at the changes to the calcout record type, which has been modified in this release to use the new dbLink generic API.</li>
</ul>
<h3>Constant Link Values</h3>
<p>Previously a constant link (i.e. a link that did not point to another PV, either locally or over Channel Access) was only able to provide a single numeric value to a record initialization; any string given in a link field that was not recognized as a number was treated as a PV name. In this release, constant links can be expressed using JSON array syntax and may provide array initialization of values containing integers, doubles or strings. An array containing a single string value can also be used to initialize scalar strings, so the stringin, stringout, lsi (long string input), lso (long string output), printf, waveform, subArray and aai (analog array input) record types and/or their soft device supports have been modified to support this.</p>
<p>Some examples of constant array and string initialized records are:</p>
<div class="fragment"><div class="line">record(stringin, &quot;const:string&quot;) {</div><div class="line">    field(INP, [&quot;Not-a-PV-name&quot;])</div><div class="line">}</div><div class="line">record(waveform, &quot;const:longs&quot;) {</div><div class="line">    field(FTVL, LONG)</div><div class="line">    field(NELM, 10)</div><div class="line">    field(INP, [1, 2, 3, 4, 5, 6, 7, 8, 9, 10])</div><div class="line">}</div><div class="line">record(aai, &quot;const:doubles&quot;) {</div><div class="line">    field(FTVL, DOUBLE)</div><div class="line">    field(NELM, 10)</div><div class="line">    field(INP, [0, 1, 1.6e-19, 2.718, 3.141593])</div><div class="line">}</div><div class="line">record(aSub, &quot;select&quot;) {</div><div class="line">    field(FTA, STRING)</div><div class="line">    field(NOA, 4)</div><div class="line">    field(INPA, [&quot;Zero&quot;, &quot;One&quot;, &quot;Two&quot;, &quot;Three&quot;])</div><div class="line">    field(FTB, SHORT)</div><div class="line">    field(NOB, 1)</div><div class="line">    field(FTVA, STRING)</div><div class="line">    field(NOVA, 1)</div><div class="line">    field(SNAM, &quot;select_asub&quot;)</div><div class="line">}</div></div><!-- fragment --><p>Reminder: Link initialization with constant values normally only occurs at record initialization time. The calcout and printf record types are the only exceptions in the Base record types to this rule, so it is generally not useful to change a const link value after iocInit.</p>
<h3>Database Parsing of "Relaxed JSON" Values</h3>
<p>A database file can now provide a "relaxed JSON" value for a database field value or an info tag. Only a few field types can currently accept such values, but the capability is now available for use in other places in the future. When writing to a JSON-capable field at run-time however, only strictly compliant JSON may be used (the dbStaticLib parser rewrites relaxed JSON values into strict JSON before passing them to the datase for interpretation, where the strict rules must be followed).</p>
<p>"Relaxed JSON" was developed to maximize compatibility with the previous database parser rules and reduce the number of double-quotes that would be needed for strict JSON syntax. The parser does accept strict JSON too though, which should be used when machine-generating database files. The differences are:</p>
<ul>
<li>Strings containing only the characters <code>a-z A-Z 0-9 _ - + .</code> do not have to be enclosed in double-quote characters.</li>
<li>The above rule applies to map keys as well as to regular string values.</li>
<li>The JSON keywords <code>null</code>, <code>true</code> and <code>false</code> (all lower-case) will be recognized as keywords, so they must be quoted to use any of these single words as a string.</li>
<li>Comments may be used, introduced as usual by the <code>#</code> character and extending to the end of the line.</li>
</ul>
<p>A JSON field or info value is only enclosed in quotes when the value being provided is a single string, and even here the quotes can be omitted in some cases as described above. The following shows both correct and incorrect excerpts from a database file:</p>
<div class="fragment"><div class="line">record(ai, math:pi) {</div><div class="line">    field(INP, {const: 3.14159265358979})   # Correct</div><div class="line">    field(SIOL, &quot;{const: 3.142857}&quot;)        # Wrong</div><div class="line"></div><div class="line">    info(autosave, {            # White-space and comments are allowed</div><div class="line">        fields:[DESC, SIMM],</div><div class="line">        pass0:[VAL]</div><div class="line">    })                          # Correct</div><div class="line">}</div></div><!-- fragment --><p>Note that the record, field and info-tag names do <em>not</em> accept JSON values, so they follows the older bareword rules for quoting where the colon <code>:</code> and several additional characters are legal in a bareword string. Only the value (after the comma) is parsed as JSON. The autosave module has not been modified to accept JSON syntax, the above is only an example of how JSON might be used.</p>
<h3>Echoless comments in iocsh</h3>
<p>The way comments are parsed by the iocsh interpreter has changed. The interpreter can be selectively disabled from echoing comments coming from a script by starting those lines with <code>#-</code> rather than just <code>#</code>.</p>
<h3>Typed record support methods</h3>
<p>The table of record support functions (rset methods for short) no longer has entries of type <code>RECSUPFUN</code> (which says: any number and type of arguments). Instead, rset methods are now typed by default. The <code>RECSUPFUN</code> typedef has been deprecated and casts to it as well as using the untyped <code>struct rset</code> will create compilation warnings.</p>
<p>Existing code (e.g. external record supports) will generate such warnings when compiled against this version of Base, but it will work without changes.</p>
<p>For a conversion period, the new typed rset definitions are activated by defining <code>USE_TYPED_RSET</code>, preferably by setting <code>USR_CPPFLAGS += -DUSE_TYPED_RSET</code> inside a Makefile. After activating the new typed rset in this way and making the following changes, the result should still compile and work properly against older versions of Base.</p>
<p>The first parameter of <code>init_record</code> and <code>process</code> has been changed to <code>struct dbCommon *</code>. Record types that use <code>void*</code> here should be changed to use <code>struct dbCommon*</code>, and cast the argument to their own <code>xxxRecord *</code>.</p>
<p>When compiled against this release, compiler warnings about incompatible types for the method pointers should be taken seriously. When compiled against older versions of base, such warnings are unavoidable.</p>
<p>Record types written in C++ need to take more drastic measures because of the stricter type checking in C++. To remain compatible with older versions of base you will need to use something like:</p>
<div class="fragment"><div class="line">#include &quot;epicsVersion.h&quot;</div><div class="line">#ifdef VERSION_INT</div><div class="line">#  if EPICS_VERSION_INT &lt; VERSION_INT(3,16,0,2)</div><div class="line">#    define RECSUPFUN_CAST (RECSUPFUN)</div><div class="line">#  else</div><div class="line">#    define RECSUPFUN_CAST</div><div class="line">#  endif</div><div class="line">#else</div><div class="line">#  define RECSUPFUN_CAST (RECSUPFUN)</div><div class="line">#endif</div></div><!-- fragment --><p>and then replace <code>(RECSUPFUN)</code> with <code>RECSUPFUN_CAST</code> when initializing the rset. Further changes might also be needed, e.g. to adapt <code>const</code>-ness of method parameters.</p>
<h2>Changes made between 3.15.3 and 3.16.0.1</h2>
<h3>Build support for CapFast and dbst removed</h3>
<p>The build rules associated with the CapFast-related tools <code>sch2edif</code> and <code>e2db</code> and the database optimization tool <code>dbst</code> have been removed, along with the <code>DB_OPT</code> build configuration variable.</p>
<h3>compressRecord buffering order</h3>
<p>The compressRecord has a new field <code>BALG</code> which can select between FIFO (append) and LIFO (prepend) ordering for insertion of new elements. FIFO ordering is the default, matching the behviour of previous versions.</p>
<h3>Valgrind Instrumentation</h3>
<p>Valgrind is a software debugging suite provided by many Linux distributions. The header valgrind/valgrind.h is now included in, and installed by, Base. When included by a C or C++ source file this header defines some macros which expand to provide hints to the Valgrind runtime. These have no effect on normal operation of the software, but when run using the valgrind tool they can help to find memory leaks and buffer overflows. Suitable hints have been added to several free-lists within libCom, including freeListLib, allowing valgrind to provide more accurate information about the source of potential leaks.</p>
<p>valgrind.h automatically disables itself when the build target is not supported by the valgrind tool. It can also explicitly be disabled by defining the macro <code>NVALGRIND</code>. See <code>src/libCom/Makefile</code> for a commented-out example.</p>
<p>As a matter of policy valgrind.h will never be included by any header file installed by Base, so its use will remain purely an implementation detail hidden from application software. Support modules which choose to use valgrind.h are advised to do likewise.</p>
<h3>Database Multi-locking</h3>
<p>The IOC record locking code has been re-written with an expanded API; global locks are no longer required by the IOC database implementation.</p>
<p>The new API functions center around <code>dbScanLockMany()</code>, which behaves like <code>dbScanLock()</code> applied to an arbitrary group of records. <code>dbLockerAlloc()</code> is used to prepare a list or record pointers, then <code>dbScanLockMany()</code> is called. When it returns, all of the records listed may be accessed (in any order) until <code>dbScanUnlockMany()</code> is called.</p>
<p>The Application Developer's Guide has been updated to describe the API and implementation is more detail.</p>
<p>Previously a global mutex <code>lockSetModifyLock</code> was locked and unlocked during <code>dbScanLock()</code>, acting as a sequencing point for otherwise unrelated calls. The new dbLock.c implementation does not include any global mutex in <code>dbScanLock()</code> or <code>dbScanLockMany()</code>. Locking and unlocking of unrelated lock sets is now completely concurrent.</p>
<h3>Generate Version Header</h3>
<p>A Perl script and Makefile rules have been added to allow modules to generate a C header file with a macro defined with an automatically updated identifier. This is a VCS revision ID (Darcs, Git, Mercurial, Subversion, and Bazaar are supported) or the date/time of the build if no VCS system is in use.</p>
<p>The makeBaseApp example template has been updated with a new device support which makes this identifier visible via a lsi (long string input) record.</p>
<h3>epicsTime API return status</h3>
<p>The epicsTime routines that used to return epicsTimeERROR now return a specific <code>S_time_</code> status value, allowing the caller to discover the reason for any failure. The identifier <code>epicsTimeERROR</code> is no longer defined, so any references to it in source code will no longer compile. The identifier epicsTimeOK still exists and has the value 0 as before, so most code that uses these APIs can be changed in a way that is backwards-compatible with the previous return status.</p>
<p>Time providers that have to return a status value and still need to be built with earlier versions of Base can define the necessary status symbols like this:</p>
<div class="fragment"><div class="line">#include &quot;epicsTime.h&quot;</div><div class="line"></div><div class="line">#ifndef M_time</div><div class="line">  /* S_time_... status values were not provided before Base 3.16 */</div><div class="line">  #define S_time_unsynchronized epicsTimeERROR</div><div class="line">  #define S_time_...whatever... epicsTimeERROR</div><div class="line">#endif</div></div><!-- fragment --><h3>Refactoring of epicsReadline</h3>
<p>The epicsReadline code has been reorganized to allow the commandline history editor to be disabled at runtime. The <code>EPICS_COMMANDLINE_LIBRARY</code> build setting still selects the preferred editor, but the new <code>IOCSH_HISTEDIT_DISABLE</code> environment variable can be set at runtime to disable history editing and make the IOC or other program use the basic editor instead. This is useful when starting and controlling an IOC from another program through its stdin and stdout streams since history editors often insert invisible escape codes into the stdout stream, making it hard to parse.</p>
<h3>Callback subsystem API</h3>
<p>Added a new macro <code>callbackGetPriority(prio, callback)</code> to the callback.h header and removed the need for dbScan.c to reach into the internals of its <code>CALLBACK</code> objects.</p>
<h1>Changes incorporated from the 3.15 branch</h1>
<h2>Changes made on the 3.15 branch since 3.15.8</h2>
<h3>Change to the <code>junitfiles</code> self-test build target</h3>
<p>The names of the generated junit xml test output files have been changed from <code>&lt;testname&gt;.xml</code> to <code>&lt;testname&gt;-results.xml</code>, to allow better distinction from other xml files. (I.e., for easy wildcard matching.)</p>
<h2>Changes made between 3.15.7 and 3.15.8</h2>
<h3>Bug fixes</h3>
<p>The following launchpad bugs have fixes included in this release:</p>
<ul>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1812084">lp: 1812084</a>, Build failure on RTEMS 4.10.2</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1829770">lp: 1829770</a>, event record device support broken with constant INP</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1829919">lp: 1829919</a>, IOC segfaults when calling dbLoadRecords after iocInit</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1838792">lp: 1838792</a>, epicsCalc bit-wise operators on aarch64</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1841608">lp: 1841608</a>, logClient falsely sends error logs on all connections</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1853168">lp: 1853168</a>, undefined reference to <code>clock_gettime()</code></li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1862328">lp: 1862328</a>, Race condition on IOC start leaves rsrv unresponsive</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1868486">lp: 1868486</a>, epicsMessageQueue lost messages</li>
</ul>
<h3>Improvements to the self-test build targets</h3>
<p>This release contains changes that make it possible to integrate another test running and reporting system (such as Google's gtest) into the EPICS build system. The built-in test-runner and reporting system will continue to be used by the test programs inside Base however.</p>
<p>These GNUmake <code>tapfiles</code> and <code>test-results</code> build targets now collect a list of the directories that experienced test failures and display those at the end of running and/or reporting all of the tests. The GNUmake process will also only exit with an error status after running and/or reporting all of the test results; previously the <code>-k</code> flag to make was needed and even that didn't always work.</p>
<p>Continuous Integration systems are recommended to run <code>make tapfiles</code> (or if they can read junittest output instead of TAP <code>make junitfiles</code>) followed by <code>make -s test-results</code> to display the results of the tests. If multiple CPUs are available the <code>-j</code> flag can be used to run tests in parallel, giving the maximum jobs that should be allowed so <code>make -j4 tapfiles</code> for a system with 4 CPUs say. Running many more jobs than you have CPUs is likely to be slower and is not recommended.</p>
<h3>Calc Engine Fixes and Enhancements</h3>
<p>The code that implements bit operations for Calc expressions has been reworked to better handle some CPU architectures and compilers. As part of this work a new operator has been added: <code>&gt;&gt;&gt;</code> performs a logical right-shift, inserting zero bits into the most significant bits (the operator <code>&gt;&gt;</code> is an arithmetic right-shift which copies the sign bit as it shifts the value rightwards).</p>
<h3>IOC logClient Changes</h3>
<p>The IOC's error logging system has been updated significantly to fix a number of issues including:</p>
<ul>
<li>Only send errlog messages to iocLogClient listeners</li>
<li>Try to minimize lost messages while the log server is down:<ul>
<li>Detect disconnects sooner</li>
<li>Don't discard the buffer on disconnect</li>
<li>Flush the buffer immediately after a server reconnects</li>
</ul>
</li>
</ul>
<h3>epicsThread: Main thread defaults to allow blocking I/O</h3>
<p>VxWorks IOCs (and potentially RTEMS IOCs running GeSys) have had problems with garbled error messages from dbStaticLib routines for some time &mdash; messages printed before <code>iocInit</code> were being queued through the errlog thread instead of being output immediately. This has been fixed by initializing the main thread with its <code>OkToBlock</code> flag set instead of cleared. IOCs running on other operating systems that use iocsh to execute the startup script previously had that set anyway in iocsh so were not affected, but this change might cause other programs that don't use iocsh to change their behavior slightly if they use <code>errlogPrintf()</code>, <code>epicsPrintf()</code> or <code>errPrintf()</code>.</p>
<h3>catools: Handle data type changes in camonitor</h3>
<p>The camonitor program didn't properly cope if subscribed to a channel whose data type changed when its IOC was rebooted without restarting the camonitor program. This has now been fixed.</p>
<h3>More Record Reference Documentation</h3>
<p>The remaining record types have had their reference pages moved from the Wiki, and some new reference pages have been written to cover the analog array and long string input and output record types plus the printf record type, none of which were previously documented. The wiki reference pages covering the fields common to all, input, and output record types have also been added, thanks to Rolf Keitel. The POD conversion scripts have also been improved and they now properly support linking to subsections in a different document, although the POD changes to add the cross-links that appeared in the original wiki pages still needs to be done in most cases.</p>
<h3>Fix build issues with newer MinGW versions</h3>
<p>The <code>clock_gettime()</code> routine is no longer used under MinGW since newer versions don't provide it any more.</p>
<h3>Fix race for port in RSRV when multiple IOCs start simultaneously</h3>
<p>If multiple IOCs were started at the same time, by systemd say, they could race to obtain the Channel Access TCP port number 5064. This issue has been fixed.</p>
<h2>Changes made between 3.15.6 and 3.15.7</h2>
<h3>GNU Readline detection on Linux</h3>
<p>Most Linux architectures should now configure themselves automatically to use the GNU Readline library if its main header file can be found in the expected place, and not try to use Readline if the header file isn't present. For older Linux architectures where libncurses or libcurses must also be linked with, the manual configuration of the <code>COMMANDLINE_LIBRARY</code> variable in the appropriate <code>configure/os/CONFIG_SITE.Common.&lt;arch&gt;</code> file will still be necessary.</p>
<h3>Replace <code>EPICS_TIMEZONE</code> with <code>EPICS_TZ</code></h3>
<p>The <code>EPICS_TIMEZONE</code> environment parameter provided time-zone information for the IOC's locale in the old ANSI format expected by VxWorks for its <code>TIMEZONE</code> environment variable, and can also used by RTEMS to set its <code>TZ</code> environment variable. However the <code>TIMEZONE</code> value has to be updated every year since it contains the exact dates of the daylight-savings time changes. The Posix TZ format that RTEMS uses contains rules that for calculating those dates, thus its value would only need updating if the rules (or the locale) are changed.</p>
<p>This release contains changes that replace the <code>EPICS_TIMEZONE</code> environment parameter with one called <code>EPICS_TZ</code> and a routine for VxWorks that calculates the <code>TIMEZONE</code> environment variable from the current <code>TZ</code> value. This routine will be run once at start-up, when the EPICS clock has synchronized to its NTP server. The calculations it contains were worked out and donated to EPICS by Larry Hoff in 2009; it is unforunate that it has taken 10 years for them to be integrated into Base.</p>
<p>The default value for the <code>EPICS_TZ</code> environment parameter is set in the Base <code>configure/CONFIG_SITE_ENV</code> file, which contains example settings for most EPICS sites that use VxWorks, and a link to a page describing the Posix TZ format for any locations that I missed.</p>
<p>If a VxWorks IOC runs continuously without being rebooted from December 31st to the start of daylight savings time the following year, its <code>TIMEZONE</code> value will be wrong as it was calculated for the previous year. This only affects times that are converted to a string on the IOC however and is easily fixed; just run the command <code>tz2timezone()</code> on the VxWorks shell and the calculation will be redone for the current year. IOCs that get rebooted at least once before the start of summer time will not need this to be done.</p>
<h3>Added new decimation channel filter</h3>
<p>A new server-side filter has been added to the IOC for reducing the number and frequency of monitor updates from a channel by a client-specified factor. The filter's behaviour is quite simplistic, it passes the first monitor event it sees to the client and then drops the next N-1 events before passing another event. For example to sample a 60Hz channel at 1Hz, a 10Hz channel every 6 seconds, or a 1Hz channel once every minute:</p>
<div class="fragment"><div class="line">Hal$ camonitor &#39;test:channel.{&quot;dec&quot;:{&quot;n&quot;:60}}&#39;</div><div class="line">...</div></div><!-- fragment --><p>More information is included in the filters documentation, which can be found in the <code>html/filters.html</code> document that is generated during the build.</p>
<h3>Imported Record Reference Documentation from Wiki</h3>
<p>The remaining record types that had 3.14 reference documentation in the EPICS Wiki have had that documentation converted and imported into their DBD files. The preferred form for future updates to the record type descriptions is now an emailed patch file, a Pull Request through GitHub, or a Merge Request through Launchpad. Note that in some cases the behavior of a record type in a 7.0.x release may differ from that of the same record type in a 3.15 release, although this would be unusual, so it may be important to indicate the branch that your changes apply to.</p>
<p><b>NOTE:</b> <em>These documentation changes have modified the order of the fields in some record definitions. As a result this release is not compatible with record or device support binaries that were compiled against earlier releases.</em></p>
<h3><code>make test-results</code> for Windows</h3>
<p>The make target <code>test-results</code> should now work properly on Windows. Some Perl installations used versions of <code>prove.bat</code> that would only display the results of up to 3 tests or didn't return an error status in the event of tests failing. The build system now calls its own perl script to summarize the results instead of passing a list of TAP filenames to <code>prove</code>.</p>
<h3>Add option to avoid CALLBACK conflict</h3>
<p>If a macro <code>EPICS_NO_CALLBACK</code> is defined, then callback.h will no longer (re)define CALLBACK. The name <code>CALLBACK</code> is used by the WIN32 API, and redefinition in callback.h cause errors if some windows headers are later included.</p>
<p>Code which defines <code>EPICS_NO_CALLBACK</code>, but still wishes to use callbacks, should use the alternate name <code>epicsCallback</code> introduced in 3.15.6, 3.16.2, and 7.0.2. It is also possible, though not encouraged, to use <code>struct callbackPvt</code> which has been present since the callback API was introduced.</p>
<h3>Cleaning up with Multiple CA contexts in a Process</h3>
<p>Bruno Martins reported a problem with the CA client library at shutdown in a process that uses multiple CA client contexts. The first context that triggers the CA client exit handler prevents any others from being able to clean up because it resets the ID of an internal epicsThreadPrivate variable which is shared by all clients. This action has been removed from the client library, which makes cleanup of clients like this possible.</p>
<h3>Perl CA bindings fixed for macOS Mojave</h3>
<p>Apple removed some Perl header files from macOS Mojave that were available in their SDK, requiring a change to the include paths used when compiling the CA bindings. The new version should build on new and older macOS versions, and these changes may also help other targets that have an incomplete installation of Perl (the build will continue after printing a warning that the Perl CA bindings could not be built).</p>
<h3>Routine <code>epicsTempName()</code> removed from libCom</h3>
<p>This routine was a simple wrapper around the C89 function <code>tmpnam()</code> which is now seen as unsafe and causes warning messages to be generated by most modern compilers. The two internal uses of this function have been modified to call <code>epicsTempFile()</code> instead. We were unable to find any published code that used this function, so it was removed immediately instead of being deprecated.</p>
<h3>DBD Parsing of Record Types</h3>
<p>The Perl DBD file parser has been made slightly more liberal; the order in which DBD files must be parsed is now more flexible, so that a record type definition can now be parsed after a device support that referred to that record type. A warning message will be displayed when the device support is seen, but the subsequent loading of the record type will be accepted without triggering an error. See <a href="https://bugs.launchpad.net/epics-base/+bug/1801145">Launchpad bug 1801145</a>.</p>
<h3>menuScan and several record types documented with POD</h3>
<p>The EPICS Wiki pages describing a number of standard record types has been converted into the Perl POD documentation format and added to the DBD files, so at build-time an HTML version of these documents is generated and installed into the htmls directory. Thanks to Tony Pietryla.</p>
<h3>CA client tools learned <code>-V</code> option</h3>
<p>This displays the version numbers of EPICS Base and the CA protocol.</p>
<h2>Changes made between 3.15.5 and 3.15.6</h2>
<h3>Unsetting environment variables</h3>
<p>The new command <code>epicsEnvUnset varname</code> can be used to unset an environment variable.</p>
<h3>Warning indicators in msi (and macLib) output</h3>
<p>The libCom macro expansion library has been modified so that when the <code>SUPPRESS_WARNINGS</code> flag is set it will no longer include any <code>,undefined</code> or <code>,recursive</code> indicators in its output when undefined or recursive macros are encountered. These indicators were harmless when the output was fed into an IOC along with a definition for the macro, but when the <code>msi</code> tool was used to generate other kinds of files they caused problems. If the <code>msi -V</code> flag is used the markers will still be present in the output whenever the appropriate condition is seen.</p>
<h3>Improvements to msi</h3>
<p>In addition to fixing its response to discovering parsing errors in its substitution input file (reported as Launchpad <a href="https://bugs.launchpad.net/epics-base/+bug/1503661">bug 1503661</a>) so it now deletes the incomplete output file, the msi program has been cleaned up a little bit internally.</p>
<h3>All array records now post monitors on their array-length fields</h3>
<p>The waveform record has been posting monitors on its NORD field since Base 3.15.0.1; we finally got around to doing the equivalent in all the other built-in record types, which even required modifying device support in some cases. This fixes <a href="https://bugs.launchpad.net/epics-base/+bug/1730727">Launchpad bug 1730727</a>.</p>
<h3>HOWTO: Converting Wiki Record Reference to POD</h3>
<p>Some documentation has been added to the <code>dbdToHtml.pl</code> script explaining how Perl POD (Plain Old Documentation) markup can be added to <code>.dbd</code> files to generate HTML documentation for the record types. To see these instructions, run <code>perl bin/&lt;host&gt;/dbdToHtml.pl -H</code> or <code>perldoc bin/&lt;host&gt;/dbdToHtml.pl</code>.</p>
<h3>Fix problem with numeric soft events</h3>
<p>Changing from numeric to named soft events introduced an incompatibility when a numeric event 1-255 is converted from a DOUBLE, e.g. from a calc record. The <code>post_event()</code> API is not marked deprecated any more.</p>
<p>Also <code>scanpel</code> has been modified to accept a glob pattern for event name filtering and to show events with no connected records as well.</p>
<h3>Add <code>osiSockOptMcastLoop_t</code> and osiSockTest</h3>
<p>Added a new OS-independent typedef for multicast socket options, and a test file to check their correct operation.</p>
<h3>Support for <code>CONFIG_SITE.local</code> in Base</h3>
<p>This feature is mostly meant for use by developers; configuration settings that would normally appear in <code>base/configure/CONFIG_SITE</code> can now be put in a locally created <code>base/configure/CONFIG_SITE.local</code> file instead of having go modify or replace the original. A new <code>.gitignore</code> pattern tells git to ignore all <code>configure/*.local</code> files.</p>
<h3>Fix broken <code>EPICS_IOC_LOG_FILE_LIMIT=0</code> setting</h3>
<p>The Application Developers' Guide says this is allowed and disables the limit on the log-file, but it hasn't actually worked for some time (if ever). Note that the iocLogServer will be removed from newer Base release sometime soon as its functionality can be implemented by other dedicated log servers such as logstash or syslog-ng.</p>
<p>Fixes <a href="https://bugs.launchpad.net/bugs/1786858">lp:1786858</a> and part of <a href="https://bugs.launchpad.net/bugs/1786966">lp:1786966</a>.</p>
<h3>Cleanup of startup directory</h3>
<p>The files in the startup directory have not been maintained in recent years and have grown crufty (technical term). This release includes the following updates to these files:</p>
<ul>
<li>The Perl <code>EpicsHostArch.pl</code> script has been rewritten, and support for a few previously missing host architectures has been added to it.</li>
<li>The <code>EpicsHostArch.pl</code> script has also been moved into the standard <code>src/tools</code> directory, from where it will be installed into <code>lib/perl</code>. In this new location it is no longer executable, so it must be run by the <code>perl</code> executable.</li>
<li>The build system has been adjusted to look for <code>EpicsHostArch.pl</code> in both places if the <code>EPICS_HOST_ARCH</code> environment variable has not been set at build-time.</li>
<li>Sites that used the original Perl script to set <code>EPICS_HOST_ARCH</code> as part of their standard environment will need to adjust their scripts when they upgrade to this release.</li>
<li>The <code>EpicsHostArch</code> shell script has been replaced with a wrapper routine that calls the Perl <code>EpicsHostArch.pl</code> script. Sites that rely on this script to set <code>EPICS_HOST_ARCH</code> should consider switching to the Perl script instead.</li>
<li>The <code>Site.cshrc</code> and <code>Site.profile</code> files have been renamed to <code>unix.csh</code> and <code>unix.sh</code>, respectively.</li>
<li>The existing <code>win32.bat</code> file has been cleaned up and a new <code>windows.bat</code> file added for 64-bit targets. The contents of these files should be seen as examples, don't uncomment or install parts for software that you don't explicitly know that you need.</li>
</ul>
<h3>Recent Apple XCode Build Issues</h3>
<p>The latest version of XCode will not compile calls to <code>system()</code> or <code>clock_settime()</code> for iOS targets. There were several places in Base where these were being compiled, although there were probably never called. The code has now been modified to permit iOS builds to complete again.</p>
<h3>Prevent illegal alarm severities</h3>
<p>A check has been added to <code>recGblResetAlarms()</code> that prevents records from getting an alarm severity higher than <code>INVALID_ALARM</code>. It is still possible for a field like HSV to get set to a value that is not a legal alarm severity, but the core IOC code should never copy such a value into a record's SEVR or ACKS fields. With this fix the record's alarm severity will be limited to <code>INVALID_ALARM</code>.</p>
<h3>Fixes for Launchpad bugs</h3>
<p>The following launchpad bugs have fixes included:</p>
<ul>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1786320">lp: 1786320</a>, dbCa subscribes twice to ENUM</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/541221">lp: 541221</a>, <code>assert (pca-&gt;pgetNative)</code> failed in ../dbCa.c</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1747091">lp: 1747091</a>, epicsTimeGetEvent() / generalTime bug</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1743076">lp: 1743076</a>, Segfault in <code>ca_attach_context()</code> during exits</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1751380">lp: 1751380</a>, Deadlock in <code>ca_clear_subscription()</code></li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1597809">lp: 1597809</a>, Setting NAME field in DB file may break IOC</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1770292">lp: 1770292</a>, <code>get_alarm_double()</code> inconsistent across record types</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1771298">lp: 1771298</a>, Conversion of NaN to integer relies on undefined behavior</li>
</ul>
<h3>Updated VxWorks Timezone settings</h3>
<p>Removed the settings for 2017; fixed the hour of the change for MET.</p>
<h3>Fixed camonitor server side relative timestamps bug</h3>
<p>Initialize the first time-stamp from the first monitor, not the client-side current time in this configuration.</p>
<h3>Build changes for MSVC</h3>
<p>Windows builds using Visual Studio 2015 and later now use the <code>-FS</code> compiler option to allow parallel builds to work properly.</p>
<p>We now give the <code>-FC</code> option to tell the compiler to print absolute paths for source files in diagnostic messages.</p>
<h3>Extend maximum Posix epicsEventWaitWithTimeout() delay</h3>
<p>The Posix implementation of epicsEventWaitWithTimeout() was limiting the timeout delay to at most 60 minutes (3600.0 seconds). This has been changed to 10 years; significantly longer maximum delays cause problems on systems where <code>time_t</code> is still a signed 32-bit integer so cannot represent absolute time-stamps after 2038-01-19. Our assumption is that such 32-bit systems will have been retired before the year 2028, but some additional tests have been added to the epicsTimeTest program to detect and fail if this assumption is violated.</p>
<h3>New test-related make targets</h3>
<p>This release adds several new make targets intended for use by developers and Continuous Integration systems which simplify the task of running the built-in self-test programs and viewing the results. Since these targets are intended for limited use they can have requirements for the build host which go beyond the standard minimum set needed to build and run Base.</p>
<h4><code>test-results</code> - Summarize test results</h4>
<p>The new make target <code>test-results</code> will run the self-tests if necessary to generate a TAP file for each test, then summarizes the TAP output files in each test directory in turn, displaying the details of any failures. This step uses the program <code>prove</code> which comes with Perl, but also needs <code>cat</code> to be provided in the default search path so will not work on most Windows systems.</p>
<h4><code>junitfiles</code> - Convert test results to JUnit XML Format</h4>
<p>The new make target <code>junitfiles</code> will run the self-tests if necessary and then convert the TAP output files into the more commonly-supported JUnit XML format. The program that performs this conversion needs the Perl module <code>XML::Generator</code> to have been installed.</p>
<h4><code>clean-tests</code> - Delete test result files</h4>
<p>The new make target <code>clean-tests</code> removes any test result files from previous test runs. It cleans both TAP and JUnit XML files.</p>
<h3>Fix DNS related crash on exit</h3>
<p>The attempt to fix DNS related delays for short lived CLI programs (eg. caget) in <a href="https://bugs.launchpad.net/epics-base/+bug/1527636">lp:1527636</a> introduced a bug which cased these short lived clients to crash on exit. This bug should now be fixed.</p>
<h3>Server bind issue on Windows</h3>
<p>When a National Instruments network variables CA server is already running on a Windows system and an IOC or PCAS server is started, the IOC's attempt to bind a TCP socket to the CA server port number fails, but Windows returns a different error status value than the IOC is expecting in that circumstance (because the National Instruments code requests exclusive use of that port, unlike the EPICS code) so the IOC fails to start properly. The relevent EPICS bind() checks have now been updated so the IOC will request that a dynamic port number be allocated for this TCP socket instead when this happens.</p>
<h3>Checking Periodic Scan Rates</h3>
<p>Code has been added to the IOC startup to better protect it against bad periodic scan rates, including against locales where <code>.</code> is not accepted as a decimal separator character. If the scan period in a menuScan choice string cannot be parsed, the associated periodic scan thread will no longer be started by the IOC and a warning message will be displayed at iocInit time. The <code>scanppl</code> command will also flag the faulty menuScan value.</p>
<h2>Changes made between 3.15.4 and 3.15.5</h2>
<h3>dbStatic Library Speedup and Cleanup</h3>
<p>Loading of database files has been optimized to avoid over-proportionally long loading times for large databases. As a part of this, the alphabetical ordering of records instances (within a record type) has been dropped. In the unexpected case that applications were relying on the alphabetic order, setting <code>dbRecordsAbcSorted = 1</code> before loading the databases will retain the old behavior.</p>
<p>The routine <code>dbRenameRecord()</code> has been removed, as it was intended to be used by database configuration tools linked against a host side version of the dbStatic library that is not being built anymore.</p>
<h3>Launchpad Bug-fixes</h3>
<p>In addition to the more detailed change descriptions below, the following Launchpad bugs have also been fixed in this release:</p>
<ul>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1440186">lp:1440186</a> Crash due to a too small buffer being provided in <code>dbContextReadNotifyCache()</code></li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1479316">lp:1479316</a> Some data races found using Helgrind</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1495833">lp:1495833</a> biRecord prompt groups are nonsensical</li>
<li><a href="https://bugs.launchpad.net/epics-base/+bug/1606848">lp:1606848</a> WSAIoctl <code>SIO_GET_INTERFACE_LIST</code> failed in Windows</li>
</ul>
<h3>Whole-Program Optimization for MS Visual Studio Targets</h3>
<p>When using the Microsoft compilers a new build system variable is provided that controls whether whole program optimization is used or not. For static builds using Visual Studio 2010 this optimization must be disabled. This is controlled in the files <code>configure/os/CONFIG_SITE.Common.windows-x64-static</code> and <code>configure/os/CONFIG_SITE.Common.win32-x86-static</code> by setting the variable <code>OPT_WHOLE_PROGRAM=NO</code> to override the default value <code>YES</code> that would otherwise be used.</p>
<p>Note that enabling this optimization slows down the build process. It is not possible to selectively disable this optimization, when building a particular module say; Microsoft's linker will restart itself automatically with the <code>-LTCG</code> flag set and display a warning if it is asked to link any object files that were compiled with the <code>-GL</code> flag.</p>
<h3>Add dynamic (variable length) array support to PCAS</h3>
<p>Dynamic array sizing support was added to the IOC server (RSRV) in the Base-3.14.12 release, but has not until now been supported in the Portable Channel Access Server (PCAS). Channel Access server applications using the PCAS may not need to be modified at all; if they already push monitors with different gdd array lengths, those variable sizes will be forwarded to any CA clients who have requested variable length updates. The example CAS server application has been modified to demonstrate this feature.</p>
<p>In implementing the above, the gdd method <code>gdd::put(const gdd *)</code> now copies the full-sized array from the source gdd if the destination gdd is of type array, has no allocated memory and a boundary size of 0.</p>
<h3>Additional epicsTime conversion</h3>
<p>The EPICS timestamp library (epicsTime) inside libCom's OSI layer has been extended by routines that convert from <code>struct tm</code> to the EPICS internal <code>epicsTime</code> type, assuming UTC - i.e. without going through the timezone mechanism. This solves issues with converting from the structured type to the EPICS timestamp at driver level from multiple threads at a high repetition rate, where the timezone mechanism was blocking on file access.</p>
<h3>MinGW Cross-builds from Linux</h3>
<p>The build configuration files that allow cross-building of the 32-bit win32-x86-mingw cross-target have been adjusted to default to building shared libraries (DLLs) as this is now supported by recent MinGW compilers. The 64-bit windows-x64-mingw cross-target was already being built that way by default. The configuration options to tell the minGW cross-compiler to link programs with static versions of the compiler support libraries have now been moved into the <code>CONFIG_SITE.linux-x86.&lt;target&gt;</code> files.</p>
<h3>General Time updates</h3>
<p>The <code>iocInit</code> code now performs a sanity check of the current time returned by the generalTime subsystem and will print a warning if the wall-clock time returned has not been initialized yet. This is just a warning message; when a time provider does synchonize the IOC will subsequently pick up and use the correct time. This check code also primes the registered event system provider if there is one so the <code>epicsTimeGetEventInt()</code> routine will work on IOCs that ask for event time within an interrupt service routine.</p>
<p>The osiClockTime provider's synchronization thread (which is only used on some embedded targets) will now poll the other time providers at 1Hz until the first time it manages to get a successful timestamp, after which it will poll for updates every 60 seconds as before.</p>
<p>The routine <code>generalTimeGetExceptPriority()</code> was designed for use by backup (lower priority) time providers like the osiClockTime provider which do not have their own absolute time reference and rely on other providers for an absolute time source. This routine no longer implements the ratchet mechanism that prevented the time it returned from going backwards. If the backup clock's tick-timer runs fast the synchronization of the backup time provider would never allow it to be corrected backwards when the ratchet was in place. The regular <code>epicsTimeGetCurrent()</code> API still uses the ratchet mechanism, so this change will not cause the IOC to see time going backwards.</p>
<h3>Microsoft Visual Studio builds</h3>
<p>The build configuration files for builds using the Microsoft compilers have been updated, although there should be no noticable difference at most sites. One extra compiler warning is now being suppressed for C++ code, <code>C4344: behavior change: use of explicit template arguments results in ...</code> which is gratuitous and was appearing frequently in builds of the EPICS V4 modules.</p>
<p>Cross-builds of the windows-x64 target from a win32-x86 host have been removed as they don't actually work within the context of a single <code>make</code> run. Significant changes to the build configuration files would be necessary for these kinds of cross-builds to work properly, which could be done if someone needs them (email Andrew Johnson before working on this, and see <a href="http://stackoverflow.com/questions/5807647/how-do-you-compile-32-bit-and-64-bit-applications-at-the-same-time-in-visual-stu">this stack-overflow answer</a> for a starting point).</p>
<h3>Bazaar keywords such as 'Revision-Id' removed</h3>
<p>In preparation for moving to git in place of the Bazaar revision control system we have removed all the keywords from the Base source code.</p>
<h3>Linux systemd service file for CA Repeater</h3>
<p>Building this version of Base on a Linux system creates a systemd service file suitable for starting the Channel Access Repeater under systemd. The file will be installed into the target bin directory, from where it can be copied into the appropriate systemd location and modified as necessary. Installation instructions are included as comments in the file.</p>
<h2>Changes made between 3.15.3 and 3.15.4</h2>
<h3>New string input device support "getenv"</h3>
<p>A new "getenv" device support for both the stringin and lsi (long string input) record types can be used to read the value of an environment variable from the IOC at runtime. See base/db/softIocExit.db for sample usage.</p>
<h3>Build rules and <code>DELAY_INSTALL_LIBS</code></h3>
<p>A new order-only prerequisite build rule has been added to ensure that library files (and DLL stubs on Windows) get installed before linking any executables, which resolves parallel build problems on high-powered CPUs. There are some (rare) cases though where a Makefile has to build an executable and run it to be able to compile code for a library built by the same Makefile. With this new build rule GNUmake will complain about a circular dependency and the build will probably fail in those cases. To avoid this problem the failing Makefile should set <code>DELAY_INSTALL_LIBS = YES</code> before including the <code>../../configure/RULES</code> file, disabling the new build rule.</p>
<h3>IOC environment variables and build parameters</h3>
<p>The IOC now sets a number of environment variables at startup that provide the version of EPICS Base it was built against (<code>EPICS_VERSION_...</code>) and its build architecture (ARCH). In some cases this allows a single iocBoot/ioc directory to be used to run the same IOC on several different architectures without any changes.</p>
<p>There are also 3 new environment parameters (<code>EPICS_BUILD_...</code>) available that C/C++ code can use to find out the target architecture, OS class and compiler class it was built with. These may be useful when writing interfaces to other languages.</p>
<h3>New implementation of <code>promptgroup</code>/<code>gui_group</code> field property</h3>
<p>The mechanism behind the <code>promptgroup()</code> field property inside a record type definition has been changed. Instead of using a fixed set of choices, the static database access library now collects the used gui group names while parsing DBD information. Group names should start with a two-digit number plus space-dash-space to allow proper sorting of groups.</p>
<p>The include file <code>guigroup.h</code> that defined the fixed set of choices has been deprecated. Instead, use the conversion functions between index number and group string that have been added to dbStaticLib.</p>
<p>When a DBD file containing record-type descriptions is expanded, any old-style <code>GUI_xxx</code> group names will be replaced by a new-style string for use by the IOC. This permits an older record type to be used with the 3.15.4 release, although eventually record types should be converted by hand with better group names used.</p>
<h3>CA server configuration changes</h3>
<p>RSRV now honors <code>EPICS_CAS_INTF_ADDR_LIST</code> and binds only to the provided list of network interfaces. Name searches (UDP and TCP) on other network interfaces are ignored. For example on a computer with interfaces 10.5.1.1/24, 10.5.2.1/24, and 10.5.3.1/24, setting <code>EPICS_CAS_INTF_ADDR_LIST='10.5.1.1 10.5.2.1'</code> will accept traffic on the .1.1 and .2.1, but ignore from .3.1</p>
<p>RSRV now honors <code>EPICS_CAS_IGNORE_ADDR_LIST</code> and ignores UDP messages received from addresses in this list.</p>
<p>Previously, CA servers (RSRV and PCAS) would build the beacon address list using <code>EPICS_CA_ADDR_LIST</code> if <code>EPICS_CAS_BEACON_ADDR_LIST</code> was no set. This is no longer done. Sites depending on this should set both environment variables to the same value.</p>
<h3>IPv4 multicast for name search and beacons</h3>
<p>libca, RSRV, and PCAS may now use IPv4 multicasting for UDP traffic (name search and beacons). This is disabled by default. To enable multicast address(s) must be listed in <code>EPICS_CA_ADDR_LIST</code> for clients and <code>EPICS_CAS_INTF_ADDR_LIST</code> for servers (IOCs should set both). For example: </p><pre class="fragment">EPICS_CAS_INTF_ADDR_LIST='224.0.2.9' EPICS_CA_ADDR_LIST=224.0.2.9
</pre><p>Please note that no IPv4 multicast address is officially assigned for Channel Access by IANA. The example 224.0.2.9 is taken from the AD-HOC Block I range.</p>
<h3>Moved <code>mlockall()</code> into its own epicsThread routine</h3>
<p>Since EPICS Base 3.15.0.2 on Posix OSs the initialization of the epicsThread subsystem has called <code>mlockall()</code> when the OS supports it and thread priority scheduling is enabled. Doing so has caused problems in third-party applications that call the CA client library, so the functionality has been moved to a separate routine <code>epicsThreadRealtimeLock()</code> which will be called by the IOC at iocInit (unless disabled by setting the global variable <code>dbThreadRealtimeLock</code> to zero).</p>
<h3>Added dbQuietMacroWarnings control</h3>
<p>When loading database files, macros get expanded even on comment lines. If a comment contains an undefined macro, the load still continues but an error message gets printed. For this release the error message has been changed to a warning, but even this warning can be made less verbose by setting this new variable to a non-zero value before loading the file, like this:</p>
<div class="fragment"><div class="line">var dbQuietMacroWarnings 1      iocsh</div><div class="line">dbQuietMacroWarnings=1          VxWorks</div></div><!-- fragment --><p>This was <a href="https://bugs.launchpad.net/bugs/541119">Launchpad bug 541119</a>.</p>
<h2>Changes from the 3.14 branch between 3.15.3 and 3.15.4</h2>
<h3>NTP Time Provider adjusts to OS tick rate changes</h3>
<p>Dirk Zimoch provided code that allows the NTP Time provider (used on VxWorks and RTEMS only) to adapt to changes in the OS clock tick rate after the provider has been initialized. Note that changing the tick rate after iocInit() is not advisable, and that other software might still misbehave if initialized before an OS tick rate change. This change was back-ported from the 3.15 branch.</p>
<h3>Making IOC <code>ca_get</code> operations atomic</h3>
<p>When a CA client gets data from an IOC record using a compound data type such as <code>DBR_TIME_DOUBLE</code> the value field is fetched from the database in a separate call than the other metadata, without keeping the record locked. This allows some other thread such as a periodic scan thread a chance to interrupt the get operation and process the record in between. CA monitors have always been atomic as long as the value data isn't a string or an array, but this race condition in the CA get path has now been fixed so the record will stay locked between the two fetch operations.</p>
<p>This fixes <a href="https://bugs.launchpad.net/epics-base/+bug/1581212">Launchpad bug 1581212</a>, thanks to Till Strauman and Dehong Zhang.</p>
<h3>New <code>CONFIG_SITE</code> variable for running self-tests</h3>
<p>The 'make runtests' and 'make tapfiles' build targets normally only run the self-tests for the main <code>EPICS_HOST_ARCH</code> architecture. If the host is able to execute self-test programs for other target architectures that are being built by the host, such as when building a <code>-debug</code> version of the host architecture for example, the names of those other architectures can be added to the new <code>CROSS_COMPILER_RUNTEST_ARCHS</code> variable in either the <code>configure/CONFIG_SITE</code> file or in an appropriate <code>configure/os/CONFIG_SITE.&lt;host&gt;.Common</code> file to have the test programs for those targets be run as well.</p>
<h3>Additional RELEASE file checks</h3>
<p>An additional check has been added at build-time for the contents of the <code>configure/RELEASE</code> file(s), which will mostly only affect users of the Debian EPICS packages published by NSLS-2. Support modules may share an install path, but all such modules must be listed adjacent to each other in any <code>RELEASE</code> files that point to them. For example the following will fail the new checks:</p>
<div class="fragment"><div class="line">AUTOSAVE = /usr/lib/epics</div><div class="line">ASYN = /home/mdavidsaver/asyn</div><div class="line">EPICS_BASE = /usr/lib/epics</div></div><!-- fragment --><p>giving the compile-time error</p>
<div class="fragment"><div class="line">This application&#39;s RELEASE file(s) define</div><div class="line">    EPICS_BASE = /usr/lib/epics</div><div class="line">after but not adjacent to</div><div class="line">    AUTOSAVE = /usr/lib/epics</div><div class="line">Module definitions that share paths must be grouped together.</div><div class="line">Either remove a definition, or move it to a line immediately</div><div class="line">above or below the other(s).</div><div class="line">Any non-module definitions belong in configure/CONFIG_SITE.</div></div><!-- fragment --><p>In many cases such as the one above the order of the <code>AUTOSAVE</code> and <code>ASYN</code> lines can be swapped to let the checks pass, but if the <code>AUTOSAVE</code> module depended on <code>ASYN</code> and hence had to appear before it in the list this error indicates that <code>AUTOSAVE</code> should also be built in its own private area; a shared copy would likely be incompatible with the version of <code>ASYN</code> built in the home directory.</p>
<h3>String field buffer overflows</h3>
<p>Two buffer overflow bugs that can crash the IOC have been fixed, caused by initializing a string field with a value larger than the field size (<a href="https://bugs.launchpad.net/bugs/1563191">Launchpad bug 1563191</a>).</p>
<h3>Fixed stack corruption bug in epicsThread C++ API</h3>
<p>The C++ interface to the epicsThread API could corrupt the stack on thread exit in some rare circumstances, usually at program exit. This bug has been fixed (<a href="https://bugs.launchpad.net/bugs/1558206">Launchpad bug 1558206</a>).</p>
<h3>RTEMS NTP Support Issue</h3>
<p>On RTEMS the NTP Time Provider could in some circumstances get out of sync with the server because the <code>osdNTPGet()</code> code wasn't clearing its input socket before sending out a new request. This (<a href="https://bugs.launchpad.net/bugs/1549908">Launchpad bug 1549908</a>) has now been fixed.</p>
<h3>CALC engine bitwise operator fixes</h3>
<p>The bitwise operators in the CALC engine have been modified to work properly with values that have bit 31 (0x80000000) set. This modification involved back-porting some earlier changes from the 3.15 branch, and fixes <a href="https://code.launchpad.net/bugs/1514520">Launchpad bug 1514520</a>.</p>
<h3>Fix <code>ipAddrToAsciiAsync()</code>: Don't try to join the daemon thread</h3>
<p>On process exit, don't try to stop the worker thread that makes DNS lookups asynchronous. Previously this would wait for any lookups still in progress, delaying the exit unnecessarily. This was most obvious with catools (eg. cainfo). <a href="https://bugs.launchpad.net/bugs/1527636">lp:1527636</a></p>
<h3>Fix <code>epicsTime_localtime()</code> on Windows</h3>
<p>Simpler versions of the <code>epicsTime_gmtime()</code> and <code>epicsTime_localtime()</code> routines have been included in the Windows implementations, and a new test program added. The original versions do not report DST status properly. Fixes <a href="https://bugs.launchpad.net/bugs/1528284">Launchpad bug 1528284</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Aug 14 2020 12:58:34 for EPICS Base by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
